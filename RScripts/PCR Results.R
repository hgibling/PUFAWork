library(tidyr)
library(dplyr)

setwd("~/Desktop/PCR Results")

file.prep <- function(filename, genename){
	file <- read.csv(filename)
	remove.excess <- file[, c(5:8)]
	grouped <- group_by(remove.excess, Sample)
	filtered.above <- filter(grouped, Cq.Std..Dev>0.2)
	filtered.below <- filter(grouped, Cq.Std..Dev<=0.2) %>%
		select(Sample, Cq.Mean)
	remove.furthest <- dplyr::mutate(filtered.above, Median.Cq=median(Cq)) %>%
		dplyr::mutate(Distance=abs(Median.Cq-Cq)) %>%
		filter(!Distance==max(Distance)) %>%
		select(Sample, Cq) %>%
		dplyr::mutate(Cq.Mean=mean(Cq)) %>%
		select(-Cq)
	combined <- bind_rows(remove.furthest, filtered.below)
	duplicates <- which(duplicated(combined$Sample)==T)
	sample.means <- arrange(combined[-duplicates,], Sample)
	colnames(sample.means) <- c("Sample", paste("Cq.Mean", genename, sep="."))
	wells.removed <- nrow(file)-nrow(combined)
	print(c("Number of wells removed:", wells.removed))
	return(sample.means)
}

Rn18s.cDNA1 <- file.prep("new cDNA1 Rn18s.csv", "Rn18s")
# file name and gene name must be in quotes
Adam9.cDNA1 <- file.prep("new cDNA1 Adam9.csv", "Adam9")
Col3a1.cDNA1 <- file.prep("new cDNA1 Col3a1.csv", "Col3a1")
Col15a1.cDNA1 <- file.prep("new cDNA1 Col15a1.csv", "Col15a1")
Lgi1.cDNA1 <- file.prep("new cDNA1 Lgi1.csv", "Lgi1")
Lyz2.cDNA1 <- file.prep("new cDNA1 Lyz2.csv", "Lyz2")
Pdgfd.cDNA1 <- file.prep("new cDNA1 Pdgfd.csv", "Pdgfd")
Vwa7.cDNA1 <- file.prep("new cDNA1 Vwa7.csv", "Vwa7")

Rn18s.cDNA2 <- file.prep("new cDNA2 Rn18s.csv", "Rn18s")
Angptl2.cDNA2 <- file.prep("new cDNA2 Angptl2.csv", "Angptl2")
Angptl4.cDNA2 <- file.prep("new cDNA2 Angptl4.csv", "Angptl4")
Hmcn1.cDNA2 <- file.prep("new cDNA2 Hmcn1.csv", "Hmcn1")
Igf1.cDNA2 <- file.prep("new cDNA2 Igf1.csv", "Igf1")
Nrp1.cDNA2 <- file.prep("new cDNA2 Nrp1.csv", "Nrp1")
Ntn4.cDNA2 <- file.prep("new cDNA2 Ntn4.csv", "Ntn4")
St3gal2.cDNA2 <- file.prep("new cDNA2 St3gal2.csv", "St3gal2")
Wnt16.cDNA2 <- file.prep("new cDNA2 Wnt16.csv", "Wnt16")


compare <- merge(rn18s, angptl4)
compare <- separate(compare, col=Sample, into=c("Sample", "Replicate"))
compare <- compare[,-2]
compare.just <- group_by(compare, Sample) %>% summarize(MeanCqRn18s=mean(Av.Cq.Rn18s), MeanCqAngptl4=mean(Av.Cq.Angptl4))

normalized <- mutate(compare.just, Normalized=MeanCqAngptl4-MeanCqRn18s)

OCvLC.dcq <- normalized[4,4]-normalized[3,4]
OCvLC.fc <- 2^((-1)*OCvLC.dcq)
# 2^ because every Cq difference equals a doubling of the strand, and -1 because lower Cq means there is more product to be detected earlier and thus the gene is present in greater amounts

ALAvLC.dcq <- normalized[1,4]-normalized[3,4]
ALAvLC.fc <- 2^((-1)*ALAvLC.dcq)

LAvLC.dcq <- normalized[2,4]-normalized[3,4]
LAvLC.fc <- 2^((-1)*LAvLC.dcq)


### other way ###

rn18s.summarized <- separate(rn18s, col=Sample, into=c("Sample", "Replicate"))
rn18s.summarized <- rn18s.summarized[,-2]
rn18s.just <- group_by(rn18s.summarized, Sample) %>% summarize(MeanCqRn18s=mean(Av.Cq.Rn18s))

angptl4.summarized <- separate(angptl4, col=Sample, into=c("Sample", "Replicate"))
angptl4.summarized <- angptl4.summarized[,-2]
angptl4.just <- group_by(angptl4.summarized, Sample) %>% summarize(MeanCqangptl4=mean(Av.Cq.Angptl4))

normalized2 <- angptl4.just[,2]-rn18s.just[,2]

OCvLC.dcq2 <- normalized2[4,]-normalized2[3,]
OCvLC.fc2 <- 2^((-1)*OCvLC.dcq2)

ALAvLC.dcq2 <- normalized2[1,]-normalized2[3,]
ALAvLC.fc2 <- 2^((-1)*ALAvLC.dcq2)

LAvLC.dcq2 <- normalized2[2,]-normalized2[3,]
LAvLC.fc2 <- 2^((-1)*LAvLC.dcq2)


### other other way ###

each.norm <- mutate(compare, Normalized=Av.Cq.Angptl4-Av.Cq.Rn18s)
grouped <- group_by(each.norm, Sample)
each.dcq <- summarize(grouped, MeanCqAngptl4=mean(Normalized))


